<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="東京記行" />
  <meta name="format-detection" content="telephone=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="mobile-web-app-capable" content="yes" />
  
  <!-- Cache Busting for all browsers -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, private" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta http-equiv="ETag" content="" />
  <meta http-equiv="Last-Modified" content="0" />
  
  <!-- Chrome-specific fixes -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="google" content="notranslate" />
  
  <!-- Force Safari to reload -->
  <script>
    // Safari-specific cache busting
    if (navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome')) {
      // Force reload for Safari
      if (performance.navigation.type === 1) {
        // Page was refreshed
        console.log('Safari page refreshed');
      } else {
        // First load - add timestamp to force fresh load
        const timestamp = new Date().getTime();
        const currentUrl = window.location.href;
        if (!currentUrl.includes('_t=')) {
          const separator = currentUrl.includes('?') ? '&' : '?';
          window.location.href = currentUrl + separator + '_t=' + timestamp;
        }
      }
    }
    
    // Chrome-specific cache busting - More aggressive approach
    if (navigator.userAgent.includes('Chrome') && !navigator.userAgent.includes('Edge')) {
      console.log('Chrome detected - applying aggressive cache busting');
      
      // Force Chrome to reload with timestamp and random parameter
      const timestamp = new Date().getTime();
      const random = Math.random().toString(36).substring(7);
      const currentUrl = window.location.href;
      
      if (!currentUrl.includes('_t=')) {
        const separator = currentUrl.includes('?') ? '&' : '?';
        const newUrl = currentUrl + separator + '_t=' + timestamp + '&r=' + random;
        console.log('Chrome: redirecting to', newUrl);
        window.location.href = newUrl;
      }
      
      // Additional Chrome-specific cache clearing
      if ('caches' in window) {
        caches.keys().then(function(names) {
          for (let name of names) {
            caches.delete(name);
          }
        });
      }
    }
  </script>
  
  <title>東京記行 — 2026-01-02 → 2026-01-08（Shopping & 美食）</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body{font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Noto Sans JP", "Microsoft JhengHei", Arial; margin:0; padding:0;}
    header{background:#222;color:#fff;padding:18px;}
    main{display:flex;flex-direction:row; gap:16px;padding:16px;}
    #left{flex:1; max-width:720px; padding-right:12px;}
    #map{flex:1; min-width:360px; height:80vh; border:1px solid #ddd;}
    
    /* Tab Styles */
    .tab-container {
      margin-bottom: 20px;
    }
    .tab-nav {
      display: flex;
      border-bottom: 2px solid #ddd;
      margin-bottom: 20px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .tab-nav button {
      background: none;
      border: none;
      padding: 12px 16px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      color: #666;
      border-bottom: 3px solid transparent;
      white-space: nowrap;
      transition: all 0.3s ease;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      min-width: 40px;
      text-align: center;
    }
    /* Enhanced tooltip styles */
    .tab-nav button:hover {
      color: #1976d2;
      background: #f5f5f5;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Tab number styling */
    .tab-nav button {
      border-radius: 6px 6px 0 0;
      margin-right: 4px;
    }
    
    /* Active tab styling */
    .tab-nav button.active {
      color: #1976d2;
      border-bottom-color: #1976d2;
      font-weight: 700;
      background: #e3f2fd;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    
    .day{border-left:4px solid #1976d2;padding:12px;margin-bottom:12px;background:#fbfbfb;}
    .place{margin:8px 0;padding:8px;border:1px dashed #eee;}
    .small{font-size:0.9rem;color:#666;}
    .btn{display:inline-block;padding:6px 10px;background:#1976d2;color:#fff;border-radius:6px;text-decoration:none;margin:6px 6px 0 0;-webkit-tap-highlight-color: transparent;}
    footer{padding:12px;color:#444;font-size:0.9rem;}
    code{background:#f6f8fa;padding:2px 4px;border-radius:4px;}
    
    /* Safari-specific fixes */
    @supports (-webkit-touch-callout: none) {
      .tab-nav {
        -webkit-overflow-scrolling: touch;
      }
      button {
        -webkit-appearance: none;
        -webkit-tap-highlight-color: transparent;
      }
    }
    
    /* iOS Safari viewport fixes */
    @media screen and (max-width: 768px) {
      main {
        flex-direction: column;
        gap: 12px;
      }
      #left, #map {
        max-width: 100%;
        min-width: auto;
      }
      #map {
        height: 60vh;
      }
    }
    
    /* Loading indicators */
    .safari-loading, .chrome-loading {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }
    .safari-loading .spinner, .chrome-loading .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1976d2;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Chrome-specific styles */
    .chrome-debug {
      font-family: 'Courier New', monospace;
    }
    .chrome-debug button:hover {
      background: #1565c0 !important;
    }
  </style>
</head>
<body>
  <!-- Chrome-specific service worker for cache busting -->
  <script>
    if (navigator.userAgent.includes('Chrome') && !navigator.userAgent.includes('Edge')) {
      console.log('Chrome detected - applying aggressive cache clearing');
      
      // Show Chrome notification
      setTimeout(function() {
        const notification = document.createElement('div');
        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #1976d2; color: white; padding: 15px; border-radius: 8px; z-index: 10000; max-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
        notification.innerHTML = '<h4>Chrome 瀏覽器檢測</h4><p>正在應用 Chrome 專用快取清除...</p><p><small>如果遇到 404 錯誤，請使用 Edge 瀏覽器</small></p>';
        document.body.appendChild(notification);
        
        // Remove notification after 5 seconds
        setTimeout(function() {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 5000);
      }, 1000);
      
      // Register service worker to clear cache
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').then(function(registration) {
          console.log('Chrome Service Worker registered');
        }).catch(function(err) {
          console.log('Chrome Service Worker registration failed');
        });
      }
      
      // Force clear all storage
      if (window.localStorage) {
        localStorage.clear();
      }
      if (window.sessionStorage) {
        sessionStorage.clear();
      }
      
      // Clear IndexedDB
      if ('indexedDB' in window) {
        indexedDB.databases().then(function(databases) {
          databases.forEach(function(db) {
            indexedDB.deleteDatabase(db.name);
          });
        });
      }
    }
  </script>
  
  <header>
    <h1>東京記行 — 2026-01-02 → 2026-01-08（Shopping & 美食）</h1>
    <div class="small">出發地：高雄 → 東京。重點：血拚 & 美食（已把你提供的餐廳/商圈納入）</div>
  </header>

  <main>
    <section id="left">
      <h2>行程總覽（按日期分頁）</h2>
      
      <!-- Tab Navigation -->
      <div class="tab-container">
        <div class="tab-nav" id="tab-nav">
          <!-- Tabs will be generated by JavaScript -->
        </div>
        
        <!-- Tab Contents -->
        <div id="tab-contents">
          <!-- Safari loading indicator -->
                  <div class="safari-loading" id="safari-loading">
          <div class="spinner"></div>
          <p>載入中... 如果是 Safari 瀏覽器，請稍等片刻</p>
          <p><small>Safari 載入較慢是正常現象</small></p>
        </div>
        
        <div class="chrome-loading" id="chrome-loading" style="display: none;">
          <div class="spinner"></div>
          <p>載入中... Chrome 瀏覽器載入中</p>
          <p><small>如果載入失敗，請嘗試重新整理頁面</small></p>
          
          <!-- Chrome Debug Panel -->
          <div class="chrome-debug" style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px; font-size: 12px;">
            <h4>Chrome 除錯資訊</h4>
            <p><strong>當前時間:</strong> <span id="chrome-time"></span></p>
            <p><strong>隨機參數:</strong> <span id="chrome-random"></span></p>
            <p><strong>直接連結測試:</strong> <a href="https://hsiuete.github.io/jptravel/itinerary.json" target="_blank" style="color: #1976d2;">點擊測試 itinerary.json</a></p>
            <p><strong>Chrome 強制重新載入:</strong> <button id="chrome-force-reload" style="background: #1976d2; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">強制重新載入</button></p>
            <p><strong>建議:</strong> 如果持續失敗，請使用 Edge 瀏覽器</p>
          </div>
        </div>
        </div>
      </div>

      <h3>重要提醒</h3>
      <ul>
        <li>吉卜力美術館 <strong>必須事先線上購票，館方不賣現場票</strong>；門票常搶手請留意開賣日與購票方式。</li>
        <li>熱門小店（如：俺流塩らーめん 表參道店）多為不接受預約、可能需排隊，建議避用餐尖峰或先到先吃。</li>
        <li>高級餐廳（伊勢丹 AGIO、Palace Hotel 餐廳、銀座名店等）常可接受線上或電話預約，若想保證晚餐位置請提早訂位。</li>
        <li>恵比寿的啤酒主題館（Yebisu Brewery / Museum）已整修重啟，參觀/導覽與品飲有固定時段與須知。</li>
      </ul>
    </section>

    <div id="map"></div>
  </main>

  <footer>
    <div>備註：本頁內「地點經緯度與營業時間」來源為官方網站與公開資料彙整；如要預約請以官方/店家頁面為準，並注意新年期間（1月上旬）店家有可能有特別營業時間或休假。</div>
    <div class="small">來源範例：Meiji Jingu 官方、俺流塩らーめん 店家、GINZA SIX 官方、Isetan AGIO 刊載資訊、Ghibli Museum 預約公告等。</div>
  </footer>

  <!-- Leaflet 和 地圖程式 -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="map.js"></script>
</body>
</html>
