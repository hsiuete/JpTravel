<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>XAMPP Test - JpTravel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
    </style>
</head>
<body>
    <h1>XAMPP 環境測試</h1>
    
    <div class="test-section info">
        <h3>檔案檢查</h3>
        <div id="file-check">檢查中...</div>
    </div>
    
    <div class="test-section info">
        <h3>JSON 格式測試</h3>
        <div id="json-test">測試中...</div>
    </div>
    
    <div class="test-section info">
        <h3>地圖載入測試</h3>
        <div id="map-test">測試中...</div>
    </div>

    <script>
        // 檔案檢查
        async function checkFiles() {
            const fileCheck = document.getElementById('file-check');
            const files = ['index.html', 'map.js', 'itinerary.json'];
            let allExist = true;
            
            for (const file of files) {
                try {
                    const response = await fetch(file);
                    if (response.ok) {
                        fileCheck.innerHTML += `<p>✅ ${file} - 存在且可存取</p>`;
                    } else {
                        fileCheck.innerHTML += `<p>❌ ${file} - HTTP ${response.status}</p>`;
                        allExist = false;
                    }
                } catch (error) {
                    fileCheck.innerHTML += `<p>❌ ${file} - 無法存取: ${error.message}</p>`;
                    allExist = false;
                }
            }
            
            if (allExist) {
                fileCheck.parentElement.className = 'test-section success';
            } else {
                fileCheck.parentElement.className = 'test-section error';
            }
        }

        // JSON 格式測試
        async function testJSON() {
            const jsonTest = document.getElementById('json-test');
            try {
                const response = await fetch('itinerary.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // 檢查必要欄位
                const requiredFields = ['trip', 'from', 'start_date', 'end_date', 'days'];
                const missingFields = requiredFields.filter(field => !data[field]);
                
                if (missingFields.length > 0) {
                    throw new Error(`缺少必要欄位: ${missingFields.join(', ')}`);
                }
                
                if (!Array.isArray(data.days) || data.days.length === 0) {
                    throw new Error('days 陣列為空或格式錯誤');
                }
                
                // 檢查每個地點是否有必要欄位
                let placeErrors = 0;
                data.days.forEach((day, dayIndex) => {
                    if (!Array.isArray(day.places)) {
                        placeErrors++;
                        return;
                    }
                    
                    day.places.forEach((place, placeIndex) => {
                        if (!place.name || !place.lat || !place.lng) {
                            placeErrors++;
                        }
                    });
                });
                
                if (placeErrors > 0) {
                    throw new Error(`${placeErrors} 個地點缺少必要欄位 (name, lat, lng)`);
                }
                
                jsonTest.innerHTML = `
                    <p>✅ JSON 格式正確</p>
                    <p>📊 統計資訊:</p>
                    <ul>
                        <li>行程: ${data.trip}</li>
                        <li>出發地: ${data.from}</li>
                        <li>日期: ${data.start_date} → ${data.end_date}</li>
                        <li>天數: ${data.days.length} 天</li>
                        <li>總地點數: ${data.days.reduce((sum, day) => sum + day.places.length, 0)} 個</li>
                    </ul>
                `;
                jsonTest.parentElement.className = 'test-section success';
                
            } catch (error) {
                jsonTest.innerHTML = `<p>❌ JSON 錯誤: ${error.message}</p>`;
                jsonTest.parentElement.className = 'test-section error';
            }
        }

        // 地圖載入測試
        async function testMap() {
            const mapTest = document.getElementById('map-test');
            try {
                // 檢查 Leaflet 是否可用
                if (typeof L === 'undefined') {
                    throw new Error('Leaflet 未載入');
                }
                
                // 檢查地圖容器
                const mapContainer = document.createElement('div');
                mapContainer.style.width = '100px';
                mapContainer.style.height = '100px';
                document.body.appendChild(mapContainer);
                
                const map = L.map(mapContainer).setView([35.68, 139.75], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
                
                document.body.removeChild(mapContainer);
                
                mapTest.innerHTML = `
                    <p>✅ Leaflet 地圖載入成功</p>
                    <p>✅ 地圖圖層載入成功</p>
                    <p>✅ 地圖初始化成功</p>
                `;
                mapTest.parentElement.className = 'test-section success';
                
            } catch (error) {
                mapTest.innerHTML = `<p>❌ 地圖載入失敗: ${error.message}</p>`;
                mapTest.parentElement.className = 'test-section error';
            }
        }

        // 執行所有測試
        window.addEventListener('load', async () => {
            await checkFiles();
            await testJSON();
            await testMap();
        });
    </script>
</body>
</html>
